<!doctype html>

<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
        <meta name="referrer" content="no-referrer" />

        <title>Just-in-Time Access</title>

        <!-- All external resources are hosted by Google -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        

        <link href="mdc/material-components-web.min.css" rel="stylesheet">
        <script src="mdc/material-components-web.min.js"></script>
        <link rel="stylesheet" href="styles.css">
    </head>
    <body>
        <main class="mdc-top-app-bar--fixed-adjust">
          <div class='jit-view' id='jit-entitlements-view'>
            <div class="mdc-data-table" id="jit-entitlements">
              <div class="mdc-data-table__table-container">
                <table class="mdc-data-table__table">
                  <thead>
                    <tr class="mdc-data-table__header-row">
                      <th class="mdc-data-table__header-cell mdc-data-table__header-cell--checkbox" role="columnheader" scope="col">
                        <div class="mdc-checkbox mdc-data-table__header-row-checkbox mdc-checkbox--selected">
                          <input type="checkbox" class="mdc-checkbox__native-control" aria-label="Toggle all rows"/>
                          <div class="mdc-checkbox__background">
                            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                              <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59" />
                            </svg>
                            <div class="mdc-checkbox__mixedmark"></div>
                          </div>
                          <div class="mdc-checkbox__ripple"></div>
                        </div>
                      </th>
                      <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Role</th>
                      <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Requirements</th>
                      <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Status</th>
                    </tr>
                  </thead>
                  <tbody class="mdc-data-table__content">
                  </tbody>
                </table>
              </div>

              <div class="mdc-data-table__progress-indicator">
                <div class="mdc-data-table__scrim"></div>
                <div class="mdc-linear-progress mdc-linear-progress--indeterminate mdc-data-table__linear-progress" role="progressbar" aria-label="Data is being loaded...">
                  <div class="mdc-linear-progress__buffer">
                    <div class="mdc-linear-progress__buffer-bar"></div>
                    <div class="mdc-linear-progress__buffer-dots"></div>
                  </div>
                  <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
                    <span class="mdc-linear-progress__bar-inner"></span>
                  </div>
                  <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
                    <span class="mdc-linear-progress__bar-inner"></span>
                  </div>
                </div>
              </div>
            </div>

            <button class="mdc-button foo-button mdc-button--raised" id="jit-requestaccess" disabled="">
              <div class="mdc-button__ripple"></div>
              <span class="mdc-button__label">Request access</span>
            </button>
          </div>
        </main>
    </body>

    <!-- script -->
    <script src="model.js"></script>
    <script src="view.js"></script>
    <script>
        "use strict"

        class EntitlementsViewBase extends ViewBase {
            constructor(selector) {
                super(selector);

                this.statusCaptions = {
                    "ACTIVE": "Active",
                    "AVAILABLE": "Available",
                    "ACTIVATION_PENDING": "Waiting for approval"
                };

                this.activationTypeCaptions = {
                    "JIT": "-",
                    "MPA": "Peer approval required",
                    "NONE": "Unavailable",
                }
            }
        }

        class ListEntitlementsView extends EntitlementsViewBase {
            constructor() {
                super('#jit-entitlements-view');
                
                this._table = new mdc.dataTable.MDCDataTable(document.querySelector('#jit-entitlements'));
                
                //
                // Setup bindings.
                //

                document.appbar.scope.onChange(async scope => {
                    this._table.showProgress();

                    try {
                        this._table.clearRows();    
                        if (scope) {
                            //
                            // Load entitlements.
                            //
                            const entitlements = await document.model.listRoles(scope);
                            this._populateList(entitlements);
                        }
                    }
                    catch (error) {
                        this.cancelView(error);
                    }
                    finally {
                        this._table.hideProgress();
                    }
                });

                const onSelectionChanged = e => {
                    const selected = this._table.getSelectedRowIds();
                    $('#jit-requestaccess').prop('disabled', selected.length == 0);
                };
                this._table.listen('MDCDataTable:rowSelectionChanged', onSelectionChanged);
                this._table.listen('MDCDataTable:selectedAll', onSelectionChanged);
                this._table.listen('MDCDataTable:unselectedAll', onSelectionChanged);

                $('#jit-requestaccess').on('click', () => {
                    new RequestDialog().showDialog();
                });
            }

            _populateList(entitlements) {
                if (entitlements.roles && entitlements.roles.length > 0) {
                    entitlements.roles.forEach(item => {
                        this._table.addRow(
                            item.roleBinding.id,
                            [
                                { text: item.roleBinding.role },
                                { text: this.activationTypeCaptions[item.activationType] ?? item.activationType },
                                { text: (this.statusCaptions[item.status] ?? item.status) + 
                                        (item.validUntil == null ? "" : ` (${Math.floor((item.validUntil * 1000 - new Date()) / (60*1000))} minutes left)`), 
                                    class: item.status === "ACTIVE" ? "activated" : null }
                            ],
                            true);
                    });

                    if (entitlements.warnings) {
                        document.appbar.showError(entitlements.warnings.join(", "));
                    }
                }
            }
        };

        $(document).ready(async () => {
            try
            {
                new ListEntitlementsView().show();

                await document.appbar.initialize();
            }
            catch (e) {
                document.appbar.showError(e ?? "No scope selected", true);
            }
            
        });
        
    </script>
</html>