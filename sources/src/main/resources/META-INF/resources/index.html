<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="referrer" content="no-referrer" />

    <title>JIT Groups</title>

    <!-- All external resources are hosted by Google -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20,300,0,0" />

    <link href="thirdparty/mdc-14.0.0/material-components-web.min.css" rel="stylesheet">
    <script src="thirdparty/mdc-14.0.0/material-components-web.min.js"></script>
    <link rel="stylesheet" href="styles.css">


    <script src="thirdparty/monaco-0.50.0/vs/loader.js"></script>
</head>
<body>
    <main class="mdc-top-app-bar--fixed-adjust">
        <!-- EnvironmentInfoView -->
        <div class='jit-view' id='jit-environmentinfo-view'>
            <h1>Systems</h1>
            <div class="jit-card">
                <span class="jit-environment-description"></span>
            </div>
            <div class="mdc-data-table">
                <div class="mdc-data-table__table-container">
                    <table class="mdc-data-table__table">
                        <thead>
                            <tr class="mdc-data-table__header-row">
                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">System</th>
                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Description</th>
                            </tr>
                        </thead>
                        <tbody class="mdc-data-table__content">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="jit-card">
                <a class="mdc-button mdc-button--outlined mdc-button--icon-leading jit-button-policy" href="#">
                    <span class="mdc-button__ripple"></span>
                    <i class="material-icons mdc-button__icon" aria-hidden="true">edit</i>
                    <span class="mdc-button__label">View policy</span>
                </a>
                <a class="mdc-button mdc-button--outlined mdc-button--icon-leading jit-button-reconcile" href="#">
                    <span class="mdc-button__ripple"></span>
                    <i class="material-icons mdc-button__icon" aria-hidden="true">sync</i>
                    <span class="mdc-button__label">Reconcile</span>
                </a>
            </div>
        </div>

        <!-- SystemInfoView -->
        <div class='jit-view' id='jit-systeminfo-view'>
            <h1>
                <a class="jit-environment-name"></a>
                <span class="jit-material-icons">chevron_right</span>
                <span class="jit-system-name"></span>
            </h1>
            <div class="jit-card">
                <span class="jit-system-description"></span>
            </div>
            <div class="mdc-data-table">
                <div class="mdc-data-table__table-container">
                    <table class="mdc-data-table__table">
                        <thead>
                            <tr class="mdc-data-table__header-row">
                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Group</th>
                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Description</th>
                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Membership</th>
                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Allowed to join</th>
                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col"></th>
                            </tr>
                        </thead>
                        <tbody class="mdc-data-table__content">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- GroupInfoView -->
        <div class='jit-view' id='jit-groupinfo-view'>
            <h1>
                <a class="jit-environment-name"></a>
                <span class="jit-material-icons">chevron_right</span>
                <a class="jit-system-name"></a>
                <span class="jit-material-icons">chevron_right</span>
                <span class="jit-group-name"></span>
            </h1>

            <div class="jit-card-subsection" title="About this group">
                <span class="jit-group-description"></span>
                <ul class="mdc-list jit-group-privileges" title="This group grants the following privileges:"></ul>

                <a href="#" class="jit-externallink-cloudconsole">Cloud Console</a> |
                <a href="#" class="jit-externallink-adminconsole">Admin Console</a> |
                <a href="#" class="jit-externallink-groupsconsole">Google Groups</a>
            </div>
            <div class="jit-card-subsection" title="My Membership">
                <ul class="mdc-list jit-group-membership"></ul>
            </div>
            <div class="jit-card-subsection jit-form" title="Join this group">
                <ul class="mdc-list jit-group-constraints" title="Membership constraints:"></ul>

                <form title="To join the group or extend your membership, provide the following information:">
                </form>

                <button class="mdc-button mdc-button--raised" type="submit">
                    <div class="mdc-button__ripple"></div>
                    <span class="mdc-button__label">Request access</span>
                </button>
            </div>
        </div>

        <!-- PolicyInfoView -->
        <div class='jit-view' id='jit-policyinfo-view'>
            <h1>
                <a class="jit-environment-name"></a>
                <span class="jit-material-icons">chevron_right</span>
                Policy
            </h1>
            <div class="jit-card-header">
                <span class="jit-policy-description"></span>
                | <a href="https://googlecloudplatform.github.io/jit-groups/policy-reference/" target="_blank">Syntax help</a>
            </div>
            <div class="jit-policy-editor">
            </div>

            <button class="mdc-button mdc-button--raised" type="submit">
                <div class="mdc-button__ripple"></div>
                <span class="mdc-button__label">Validate</span>
            </button>
            <div class="jit-policy-editor-issues">
                <div class="mdc-data-table">
                    <div class="mdc-data-table__table-container">
                        <table class="mdc-data-table__table">
                            <thead>
                                <tr class="mdc-data-table__header-row">
                                    <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Description</th>
                                    <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Scope</th>
                                </tr>
                            </thead>
                            <tbody class="mdc-data-table__content">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ComplianceInfoView -->
        <div class='jit-view' id='jit-complianceinfo-view'>
            <h1>
                <a class="jit-environment-name"></a>
                <span class="jit-material-icons">chevron_right</span>
                Compliance
            </h1>
            <div class="jit-card">
                Reconciling the environment policy:

                <ul>
                    <li>Find Cloud Identity groups that are no longer covered by the current environment policy</li>
                    <li>Ensure that IAM policies match the privileges defined in the environment policy</li>
                    <li>Detect legacy roles that can't be mapped to JIT groups</li>
                </ul>

                The following issues have been detected:
            </div>
            <div class="mdc-data-table">
                <div class="mdc-data-table__table-container">
                    <table class="mdc-data-table__table">
                        <thead>
                            <tr class="mdc-data-table__header-row">
                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Group</th>
                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">System</th>
                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Environment</th>
                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Email</th>
                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Status</th>
                            </tr>
                        </thead>
                        <tbody class="mdc-data-table__content">
                        </tbody>
                    </table>
                </div>

                <div class="mdc-data-table__progress-indicator">
                    <div class="mdc-data-table__scrim"></div>
                    <div class="mdc-linear-progress mdc-linear-progress--indeterminate mdc-data-table__linear-progress" role="progressbar" aria-label="Data is being loaded...">
                        <div class="mdc-linear-progress__buffer">
                            <div class="mdc-linear-progress__buffer-bar"></div>
                            <div class="mdc-linear-progress__buffer-dots"></div>
                        </div>
                        <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
                            <span class="mdc-linear-progress__bar-inner"></span>
                        </div>
                        <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
                            <span class="mdc-linear-progress__bar-inner"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ProposalInfoView -->
        <div class='jit-view' id='jit-proposalinfo-view'>
            <h1>
                <a class="jit-environment-name"></a>
                <span class="jit-material-icons">chevron_right</span>
                <a class="jit-system-name"></a>
                <span class="jit-material-icons">chevron_right</span>
                <a class="jit-group-name"></a>
                <span class="jit-material-icons">chevron_right</span>
                <span class="jit-user-name"></span>
            </h1>

            <div class="jit-card-subsection" title="Group details">
                <span class="jit-group-description"></span>
                <ul class="mdc-list jit-group-privileges" title="This group grants the following privileges:"></ul>
                <a href="#" class="jit-externallink-cloudconsole">Cloud Console</a> |
                <a href="#" class="jit-externallink-adminconsole">Admin Console</a> |
                <a href="#" class="jit-externallink-groupsconsole">Google Groups</a>
            </div>
            <div class="jit-card-subsection" title="Request details">
                <ul class="mdc-list jit-join-inputs" title="Details:"></ul>
                <ul class="mdc-list jit-proposal-details" title="Status"></ul>
            </div>
            <div class="jit-card-subsection jit-form" title="Approve this request">
                <ul class="mdc-list jit-group-constraints" title="Approval constraints:"></ul>
                <form title="To approve this request, provide the following information:">
                </form>

                <button class="mdc-button mdc-button--raised" type="submit">
                    <div class="mdc-button__ripple"></div>
                    <span class="mdc-button__label">Approve</span>
                </button>
            </div>
        </div>

        <!-- WaitDialog -->
        <div class="mdc-dialog" id="jit-wait-dialog">
            <div class="mdc-dialog__container">
                <div class="mdc-dialog__surface" role="alertdialog" aria-modal="true">
                    <h2 class="mdc-dialog__title">Please wait...</h2>
                    <div class="mdc-dialog__content">
                        <div role="progressbar" class="mdc-linear-progress mdc-linear-progress--indeterminate" aria-label="Progress Bar" aria-valuemin="0" aria-valuemax="1" aria-valuenow="0">
                            <div class="mdc-linear-progress__buffer">
                                <div class="mdc-linear-progress__buffer-bar"></div>
                                <div class="mdc-linear-progress__buffer-dots"></div>
                            </div>
                            <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
                                <span class="mdc-linear-progress__bar-inner"></span>
                            </div>
                            <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
                                <span class="mdc-linear-progress__bar-inner"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- script -->
    <script src="model.js"></script>
    <script src="view.js"></script>
    <script>
        "use strict"

        class WaitDialog extends DialogBase {
            constructor() {
                super('#jit-wait-dialog');

                const progressBar = new mdc.linearProgress.MDCLinearProgress(this.select('.mdc-linear-progress').get(0));
            }
        }

        class CatalogViewBase extends ViewBase {
            constructor(selector) {
                super(selector);
            }
        }

        class EnvironmentInfoView extends CatalogViewBase {
            constructor(model) {
                super('#jit-environmentinfo-view');

                console.assert(model);

                this.table = new mdc.dataTable.MDCDataTable(this.select('table').get(0));
                this.table.clearRows();

                this.select('h1').text(model.content.displayName);
                this.select('.jit-environment-description').text(model.content.description);

                this.select('.jit-button-policy')
                    .prop('href', `#!/${model.content.policy != null ? model.content.policy.href : '#'}`)
                    .toggle(model.content.policy != null);
                this.select('.jit-button-reconcile')
                    .prop('href', `#!/${model.content.reconcile != null ? model.content.reconcile.href : '#'}`)
                    .toggle(model.content.reconcile != null);

                if (model.content.systems) {
                    model.content.systems.forEach(item => {
                        this.table.addRow(
                            item.id,
                            [
                                { text: item.displayName, icon: 'deployed_code', href: `#!/${item.self.href}` },
                                { text: item.description, maxLength: 40 }
                            ],
                            false);
                    });
                }
            }
        }

        class SystemInfoView extends CatalogViewBase {
            constructor(model) {
                super('#jit-systeminfo-view');

                console.assert(model);

                this.table = new mdc.dataTable.MDCDataTable(this.select('table').get(0));
                this.table.clearRows();

                this.select('.jit-environment-name')
                    .text(model.content.environment.displayName)
                    .prop('href', `#!/${model.content.environment.self.href}`);
                this.select('.jit-system-name').text(model.content.displayName);
                this.select('.jit-system-description').text(model.content.description);

                if (model.content.groups) {
                    model.content.groups.forEach(item => {
                        this.table.addRow(
                            item.id,
                            [
                                { text: item.displayName, icon: 'group', href: `#!/${item.self.href}` },
                                { text: item.description, maxLength: 70 },
                                {
                                    text: item.join.membership.active ? `${Duration.untilUnixTime(item.join.membership.expiry).format()} left` : "-",
                                    icon: item.join.membership.active ? "check" : null,
                                    class: item.join.membership.active ? 'activated' : null
                                },
                                { 
                                    icon: item.join.status == 'JOIN_DISALLOWED' ? 'close': 'check'
                                },
                                {
                                    menu: [
                                        { text: 'One', href:'#' },
                                        { text: 'Two..........................' }
                                    ]
                                }
                            ],
                            false);
                    });
                }
            }
        }

        class GroupInfoViewBase extends CatalogViewBase {
            constructor(model, selector) {
                super(selector);

                console.assert(model);

                this.privileges = new mdc.list.MDCList(this.select('.jit-group-privileges').get(0));
                this.constraints = new mdc.list.MDCList(this.select('.jit-group-constraints').get(0));
                this.formFields = []
                this.form = this.select('form');

                this.select('button[type="submit"]').unbind('click').click(async () => {
                    var dialog = new WaitDialog();
                    dialog.showAsync();

                    try {
                        this._bind(await model.postback(this.select('form').serialize()));
                    }
                    catch (e) {
                        document.appbar.showError(e, false);
                    }
                    finally {
                        dialog.close();
                    }
                });
            }

            _bind(groupInfo) {
                console.assert(groupInfo._type === 'GroupInfo');
                this._bindGroupDetails(groupInfo);
                this._bindGroupPrivileges(groupInfo);
            }

            _bindGroupDetails(groupInfo) {
                console.assert(groupInfo._type === 'GroupInfo');

                this.select('.jit-environment-name')
                    .text(groupInfo.environment.displayName)
                    .prop('href', `#!/${groupInfo.environment.self.href}`);
                this.select('.jit-system-name')
                    .text(groupInfo.system.displayName)
                    .prop('href', `#!/${groupInfo.system.self.href}`);
                this.select('.jit-group-name').text(groupInfo.displayName);
                this.select('.jit-group-description').text(groupInfo.description);

                this.select('.jit-externallink-cloudconsole')
                    .prop('href', `#!/${groupInfo.self.href}/link/cloud-console`);
                this.select('.jit-externallink-adminconsole')
                    .prop('href', `#!/${groupInfo.self.href}/link/admin-console`);
                this.select('.jit-externallink-groupsconsole')
                    .prop('href', `#!/${groupInfo.self.href}/link/groups-console`);
            }

            _bindGroupPrivileges(groupInfo) {
                console.assert(groupInfo._type === 'GroupInfo');

                this.privileges.clearRows();

                if (groupInfo.privileges) {
                    groupInfo.privileges.forEach(item => {
                        this.privileges.addRow({
                            primary: item.description,
                            icon: 'license'
                        });
                    });
                }
            }

            _bindConstraints(satisfiedConstraints, unsatisfiedConstraints) {
                this.constraints.clearRows();
                this.form.empty();
                this.form.append($(`<input type='hidden' name='__ignore' value='0'>`)); // Ensure there's at least one field.
                this.select('.jit-form').show();

                if (satisfiedConstraints) {
                    satisfiedConstraints.forEach(item => {
                        this.constraints.addRow({
                            primary: item.description,
                            icon: 'check'
                        });
                    });
                }

                if (unsatisfiedConstraints) {
                    unsatisfiedConstraints.forEach(item => {
                        this.constraints.addRow({
                            primary: item.description,
                            icon: 'exclamation'
                        });
                    });
                }
            }

            _createInputForProperty(input) {
                switch (input.type) {
                    case "String": {
                        const element = $(`
                            <label class="mdc-text-field mdc-text-field--outlined">
                                <span class="mdc-notched-outline">
                                    <span class="mdc-notched-outline__leading"></span>
                                    <span class="mdc-notched-outline__notch">
                                        <span class="mdc-floating-label jit-description"></span>
                                    </span>
                                    <span class="mdc-notched-outline__trailing"></span>
                                </span>
                                <input type="text" class="mdc-text-field__input" name="${input.name}" autocomplete="off">
                            </label>
                            <div class="mdc-text-field-helper-line">
                              <div class="mdc-text-field-character-counter"></div>
                            </div>`);
                        element.find('.jit-description').text(input.description);

                        if (input.minInclusive) {
                            element.find('input').prop('minlength', input.minInclusive);
                        }

                        if (input.maxInclusive) {
                            element.find('input').prop('maxlength', input.maxInclusive);
                        }

                        const textField = new mdc.textField.MDCTextField(element.get(0));
                        textField.required = input.isRequired;
                        this.formFields.push(textField);

                        return element;
                    }

                    case "Boolean": {
                        const element = $(`
                            <div class="mdc-form-field" style="display: flex">
                              <div class="mdc-checkbox">
                                <input type="checkbox" class="mdc-checkbox__native-control" name="${input.name}" id="${input.name}"/>
                                <div class="mdc-checkbox__background">
                                  <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                    <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                                  </svg>
                                  <div class="mdc-checkbox__mixedmark"></div>
                                </div>
                                <div class="mdc-checkbox__ripple"></div>
                                <div class="mdc-checkbox__focus-ring"></div>
                              </div>
                              <label class="jit-description" for="${input.name}"></label>
                            </div>`);
                        element.find('.jit-description').text(input.description);

                        const checkbox = new mdc.checkbox.MDCCheckbox(element.find('.mdc-checkbox').get(0));
                        const formField = new mdc.formField.MDCFormField(element.get(0));
                        formField.input = checkbox;

                        return element;
                    }

                    case "Duration": {
                        const element = $(`
                             <div class="mdc-select mdc-select--outlined ">
                                <div class="mdc-select__anchor" role="button">
                                <span class="mdc-notched-outline">
                                    <span class="mdc-notched-outline__leading"></span>
                                    <span class="mdc-notched-outline__notch">
                                    <span class="mdc-floating-label jit-description"></span>
                                    </span>
                                    <span class="mdc-notched-outline__trailing"></span>
                                </span>
                                <span class="mdc-select__selected-text-container">
                                    <span class="mdc-select__selected-text"></span>
                                </span>
                                <span class="mdc-select__dropdown-icon">
                                    <svg
                                        class="mdc-select__dropdown-icon-graphic"
                                        viewBox="7 10 10 5" focusable="false">
                                    <polygon
                                        class="mdc-select__dropdown-icon-inactive"
                                        stroke="none"
                                        fill-rule="evenodd"
                                        points="7 10 12 15 17 10">
                                    </polygon>
                                    <polygon
                                        class="mdc-select__dropdown-icon-active"
                                        stroke="none"
                                        fill-rule="evenodd"
                                        points="7 15 12 10 17 15">
                                    </polygon>
                                    </svg>
                                </span>
                                </div>
                                <div class="mdc-select__menu mdc-menu mdc-menu-surface mdc-menu-surface--fullwidth">
                                    <ul class="mdc-deprecated-list jit-options" role="listbox">
                                        <li class="mdc-deprecated-list-item mdc-deprecated-list-item--selected" aria-selected="true" data-value="" role="option">
                                            <span class="mdc-deprecated-list-item__ripple"></span>
                                        </li>
                                    </ul>
                                </div>
                                <input type="hidden" name="${input.name}">
                            </div>`);
                        element.find('.jit-description').text(input.description);

                        const choices = Duration.range(
                            input.minInclusive !== null ? Duration.parse(input.minInclusive) : null,
                            input.maxInclusive !== null ? Duration.parse(input.maxInclusive) : null);
                        choices.forEach(ch => {
                            element.find('.jit-options').append(`
                                 <li class="mdc-deprecated-list-item" aria-selected="false" data-value="${ch.toString()}" role="option">
                                    <span class="mdc-deprecated-list-item__ripple"></span>
                                    <span class="mdc-deprecated-list-item__text">
                                        ${ch.format()}
                                    </span>
                                </li>`);
                        })

                        const selectField = new mdc.select.MDCSelect(element.get(0));
                        selectField.required = input.isRequired;
                        selectField.listen('MDCSelect:change', () => {
                            element.find('input[type="hidden"]').val(selectField.value);
                        });

                        this.formFields.push(selectField);

                        return element;
                    }

                    case "Long": {
                        const element = $(`
                             <label class="mdc-text-field mdc-text-field--outlined">
                                 <span class="mdc-notched-outline">
                                     <span class="mdc-notched-outline__leading"></span>
                                     <span class="mdc-notched-outline__notch">
                                        <span class="mdc-floating-label jit-description"></span>
                                     </span>
                                     <span class="mdc-notched-outline__trailing"></span>
                                 </span>
                                 <input type="number" name="${input.name}" class="mdc-text-field__input">
                             </label>`);
                        element.find('.jit-description').text(input.description);

                        const datetimeInput = element.find('input');
                        if (input.minInclusive) {
                            datetimeInput.prop('min', input.minInclusive);
                        }

                        if (input.maxInclusive) {
                            datetimeInput.prop('max', input.maxInclusive);
                        }

                        const textField = new mdc.textField.MDCTextField(element.get(0));
                        textField.required = input.isRequired;
                        this.formFields.push(textField);

                        return element;
                    }
                }
            } 
        }

        class GroupInfoView extends GroupInfoViewBase {
            constructor(model) {
                super(model, '#jit-groupinfo-view');

                this.membership = new mdc.list.MDCList(this.select('.jit-group-membership').get(0));

                this._bind(model.content);
            }

            _bind(groupInfo) {
                super._bind(groupInfo);
                this._bindGroupMembership(groupInfo);
                this._bindConstraints(groupInfo.join.satisfiedConstraints, groupInfo.join.unsatisfiedConstraints)

                switch (groupInfo.join.status) {
                    case 'JOIN_ALLOWED_WITHOUT_APPROVAL':
                    case 'JOIN_ALLOWED_WITH_APPROVAL':
                    case 'JOINED':
                        this.select('.jit-form').show();
                        groupInfo.join.input.forEach(item => {
                            this.select('form').append(this._createInputForProperty(item));
                        });
                        break;

                    case 'JOIN_COMPLETED':
                    case 'JOIN_PROPOSED':
                    case 'JOIN_DISALLOWED':
                        this.select('.jit-form').hide();
                }
            }

            _bindGroupMembership(groupInfo) {
                console.assert(groupInfo._type === 'GroupInfo');
                this.membership.clearRows();

                if (groupInfo.join.membership.active) {
                    this.membership.addRow({
                        icon: 'check',
                        primary: `${Duration.untilUnixTime(groupInfo.join.membership.expiry).format()} left`,
                        primaryTitle: `Your membership expires on ${Instant.fromUnixTime(groupInfo.join.membership.expiry)}`,
                        primaryClass: 'activated'
                    });
                    this.membership.addRow({
                        primary: "You can extend your membership before it expires",
                        icon: 'check'
                    });

                    $('.jit-form').attr('title', 'Extend my membership');
                }
                else if (groupInfo.join.status != 'JOIN_PROPOSED') {
                    this.membership.addRow({
                        primary: "You are not a member of this group",
                        icon: 'group_off'
                    });
                }

                if (groupInfo.join.status == 'JOIN_DISALLOWED') {
                    this.membership.addRow({
                        primary: "You don't have sufficient access to join this group",
                        icon: 'close'
                    });
                }
                else if (groupInfo.join.status == 'JOIN_ALLOWED_WITH_APPROVAL') {
                    this.membership.addRow({
                        primary: "You can request to join this group",
                        icon: 'mail'
                    });
                }
                else if (groupInfo.join.status == 'JOIN_ALLOWED_WITHOUT_APPROVAL') {
                    this.membership.addRow({
                        primary: "You can join this group without approval",
                        icon: 'person_add'
                    });
                }
                else if (groupInfo.join.status == 'JOIN_PROPOSED') {
                    this.membership.addRow({
                        primary: "Your request to join the group was sent for approval",
                        icon: 'outgoing_mail'
                    });
                }
            }
        }

        class ProposalInfoView extends GroupInfoViewBase {
            constructor(model) {
                super(model, '#jit-proposalinfo-view');

                this.constraints = new mdc.list.MDCList(this.select('.jit-group-constraints').get(0));
                this.joinInputs = new mdc.list.MDCList(this.select('.jit-join-inputs').get(0));
                this.proposalDetails = new mdc.list.MDCList(this.select('.jit-proposal-details').get(0));

                this.select('.jit-group-name')
                    .prop('href', `#!/${model.content.approval.group.self.href}`);
                this.select('.jit-user-name').text(model.content.user);

                this._bind(model.content);
            }


            _bind(proposalInfo) {
                console.assert(proposalInfo._type === 'ProposalInfo');
                super._bind(proposalInfo.approval.group);

                this.joinInputs.clearRows();
                this.proposalDetails.clearRows();

                this.joinInputs.addRow({
                    key: 'User',
                    value: proposalInfo.user
                });

                if (proposalInfo.approval.group.join.input) {
                    proposalInfo.approval.group.join.input.forEach(input => {
                        this.joinInputs.addRow({
                            key: input.description,
                            value: input.type === 'Duration' ? Duration.parse(input.value).format() : input.value
                        });
                    });
                }

                this._bindConstraints(proposalInfo.approval.satisfiedConstraints, proposalInfo.approval.unsatisfiedConstraints)

                switch (proposalInfo.approval.status) {
                    case 'APPROVAL_ALLOWED':
                        this.select('.jit-form').show();
                        proposalInfo.approval.input.forEach(item => {
                            this.select('form').append(this._createInputForProperty(item));
                        });
                        break;

                    case 'APPROVAL_COMPLETED':
                        this.proposalDetails.addRow({
                            primary: 'Request approved',
                            icon: 'check'
                        });
                        // Fallthru.

                    case 'APPROVAL_DISALLOWED':
                        this.select('.jit-form').hide();
                }
            }
        }

        class PolicyInfoView extends CatalogViewBase {
            constructor(model) {
                super('#jit-policyinfo-view');

                console.assert(model);

                this.table = new mdc.dataTable.MDCDataTable(this.select('table').get(0));
                this.table.clearRows();

                this.select('.jit-environment-name')
                    .text(model.content.environment.displayName)
                    .prop('href', `#!/${model.content.environment.self.href}`);
                this.select('.jit-policy-description')
                    .text(`${model.content.source} (${new Date(model.content.lastModified * 1000).toLocaleString()})`)

                require.config({ paths: { vs: 'thirdparty/monaco-0.50.0/vs' } });

                const editorDiv = this.select('.jit-policy-editor').get(0);
                let editor;
                require(['vs/editor/editor.main'], function () {
                    editor = monaco.editor.create(
                        editorDiv,
                        {
                            value: model.content.policy,
                            language: 'yaml',
                            minimap: { enabled: false },
                        });
                });


                this.select('button[type="submit"]').unbind('click').click(async () => {
                    var dialog = new WaitDialog();
                    dialog.showAsync();

                    try {

                        this._showLintingResult(await model.postback(
                            `source=${encodeURIComponent(editor.getValue())}`,
                            '/policy/lint'));
                    }
                    catch (e) {
                        document.appbar.showError(e, false);
                    }
                    finally {
                        dialog.close();
                    }
                });

                this._showLintingResult({ successful: true });
            }

            _showLintingResult(result) {
                this.table.clearRows();
                if (result.successful) {
                    this.table.addRow(
                        "",
                        [
                            { text: 'OK', icon: 'check' },
                            { text: 'file' }
                        ],
                        false);
                }
                else {
                    result.issues.forEach(issue => {
                        this.table.addRow(
                            "",
                            [
                                { text: issue.details, icon: issue.error ? 'close' : 'warning' },
                                { text: issue.scope }
                            ],
                            false);
                    });
                }
            }
        }

        class ComplianceInfoView extends CatalogViewBase {
            constructor(model) {
                super('#jit-complianceinfo-view');

                console.assert(model);
                this.model = model;

                this.table = new mdc.dataTable.MDCDataTable(this.select('.mdc-data-table').get(0));
                this.table.clearRows();

                this.select('.jit-environment-name')
                    .text(model.content.environment.displayName)
                    .prop('href', `#!/${model.content.environment.self.href}`);
            }

            async showAsync() {
                var showResult = await super.showAsync();

                this.table.showProgress();
                try {
                    var reconciliationResult = await this.model.postback()

                    if (reconciliationResult.issues && reconciliationResult.issues.length > 0) {
                        reconciliationResult.issues.forEach(item => {
                            this.table.addRow(
                                item.id,
                                [
                                    { text: item.group, icon: 'close' },
                                    { text: item.system },
                                    { text: item.environment },
                                    { text: item.cloudIdentityGroupId },
                                    { text: item.details }
                                ],
                                false);
                        });
                    }
                    else {
                        this.table.addRow(
                            '',
                            [
                                { text: 'No issues found', icon: 'check' },
                                { text: '' },
                                { text: '' },
                                { text: '' },
                                { text: '' }
                            ],
                            false);
                    }
                }
                finally {
                    this.table.hideProgress();
                }

                return showResult;
            }
        }

        async function routeToView() {
            let view;
            try {
                const model = await document.appbar.loadModel();
                if (!model) {
                    return;
                }

                switch (model.content._type) {
                    case "EnvironmentInfo":
                        view = new EnvironmentInfoView(model);
                        await view.showAsync();
                        break;

                    case "SystemInfo":
                        view = new SystemInfoView(model);
                        await view.showAsync();
                        break;

                    case "GroupInfo":
                        view = new GroupInfoView(model);
                        await view.showAsync();
                        break;

                    case "PolicyInfo":
                        view = new PolicyInfoView(model);
                        await view.showAsync();
                        break;

                    case "ComplianceInfo":
                        view = new ComplianceInfoView(model);
                        await view.showAsync();
                        break;

                    case "ProposalInfo":
                        view = new ProposalInfoView(model);
                        await view.showAsync();
                        break;

                    case "ExternalLinkInfo":
                        window.location.href = model.content.location.href;
                        break;
                }
                
            }
            catch (e) {
                if (view) {
                    view.cancelView(e);
                }

                document.appbar.showError(e ?? "No environment selected", true);
            }
        }

        const fragmentTarget = new URLSearchParams(window.location.search).get("f");
        if (fragmentTarget) {
            //
            // Redirect and use the parameter as fragment.
            //
            window.location = `/#!${fragmentTarget}`;
        }
        else {
            //
            // Route based on fragment.
            //
            window.onhashchange = routeToView;
            $(document).ready(routeToView);
        }
    </script>
  </body>
</html>