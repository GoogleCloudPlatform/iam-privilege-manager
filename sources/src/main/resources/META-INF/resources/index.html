<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="referrer" content="no-referrer" />

    <title>Just-in-Time Access</title>

    <!-- All external resources are hosted by Google -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="/mdl-1.3.0/material.indigo-pink.min.css" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>

    <script defer src="/mdl-1.3.0/material.min.js"></script>
    <script defer src="stepper.min.js"></script>

    <link rel="stylesheet" href="stepper.min.css" />
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="mdl-layout mdl-js-layout">
        <header class="mdl-layout__header mdl-layout__header--transparent">
            <div class="mdl-layout__header-row">
                <!-- Title -->
                <span class="mdl-layout-title">Just-in-Time Access</span>
            </div>
        </header>
        <div class="mdl-layout__drawer">
            <span class="mdl-layout-title">JIT Access</span>
            <nav class="mdl-navigation">
                <a class="mdl-navigation__link" href="#" id="menu-requestaccess">Request access</a>
                <a class="mdl-navigation__link" href="#" id="menu-help">User guide</a>
            </nav>
        </div>
        <main class="mdl-layout__content app-pane" id="request-pane">
            <div class="mdl-grid center-items">
                <!-- stepper -->
                <ul class="mdl-stepper mdl-stepper--feedback mdl-stepper--linear mdl-stepper--vertical">
                    <li class="mdl-step" id="step-selectproject">
                        <span class="mdl-step__label">
                            <span class="mdl-step__title">
                                <span class="mdl-step__title-text">Project</span>
                            </span>
                        </span>
                        <div class="mdl-step__content">
                            <div class="step-subsection">
                                Select the project to request access to:
                            </div>
                            <div class="step-subsection">
                                <form action="#">
                                    <div>
                                        <fieldset id="project-selector">
                                            <legend>Project ID</legend>
                                            <img src="icon.search.svg" />
                                            <input id="project-selector-search"
                                                   type="text"
                                                   maxlength="32" autocomplete="off" autofocus />
                                        </fieldset>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="mdl-step__actions">
                            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--colored mdl-button--raised" data-stepper-next>
                                Continue
                            </button>
                        </div>

                    </li>
                    <li class="mdl-step" id="step-selectrole">
                        <span class="mdl-step__label">
                            <span class="mdl-step__title">
                                <span class="mdl-step__title-text">Roles to activate</span>
                            </span>
                        </span>
                        <div class="mdl-step__content">
                            <div class="step-subsection">
                                Select the roles that you want to activate for this project:
                            </div>
                            <div class="step-subsection">
                                <table class="mdl-data-table mdl-shadow--2dp" id="step-selectrole-roles">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th class="mdl-data-table__cell--non-numeric">Role</th>
                                            <th class="mdl-data-table__cell--non-numeric">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="mdl-step__actions">
                            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--colored mdl-button--raised" data-stepper-next>
                                Continue
                            </button>
                            <button class="mdl-button mdl-js-button mdl-js-ripple-effect" data-stepper-cancel>
                                Cancel
                            </button>
                        </div>
                    </li>
                    <li class="mdl-step" id="step-approve">
                        <span class="mdl-step__label">
                            <span class="mdl-step__title">
                                <span class="mdl-step__title-text">Approval and justification</span>
                            </span>
                        </span>
                        <div class="mdl-step__content">
                            <div class="step-subsection conditional-mpa">
                                Activating this role requires approval from one of the following peers. Select
                                one or more peers to send an approval request:
                            </div>
                            <div class="step-subsection conditional-mpa">
                                <table class="mdl-data-table mdl-shadow--2dp" id="step-approve-peers">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th class="mdl-data-table__cell--non-numeric">User</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                            <div class="step-subsection">
                                Enter a justification that explains why you need to access the project:
                            </div>
                            <div class="step-subsection">
                                <form action="#">
                                    <div>
                                        <fieldset>
                                            <legend>Justification</legend>
                                            <input id="justification"
                                                   type="text"
                                                   maxlength="100"
                                                   autocomplete="off" />
                                        </fieldset>
                                    </div>
                                </form>
                            </div>
                            <div class="step-subsection">
                                The justification
                                is logged and might be reviewed by an auditor.
                            </div>
                        </div>
                        <div class="mdl-step__actions">
                            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--colored mdl-button--raised" data-stepper-next>
                                Request access
                            </button>
                            <button class="mdl-button mdl-js-button mdl-js-ripple-effect" data-stepper-cancel>
                                Cancel
                            </button>
                        </div>
                    </li>
                </ul>
            </div>
        </main>
        <main class="mdl-layout__content app-pane" id="busy-pane">
            <div class="mdl-grid center-items">
                <div class="mdl-card mdl-shadow--2dp">
                    <div class="mdl-card__title">
                        <h2 class="mdl-card__title-text">Please wait</h2>
                    </div>
                    <div class="mdl-card__supporting-text">
                        Your request is being processed...
                        <div>
                            <div class="mdl-progress mdl-js-progress mdl-progress__indeterminate"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <main class="mdl-layout__content app-pane" id="request-status-pane">
            <div class="mdl-grid center-items">
                <div class="mdl-card mdl-shadow--2dp">
                    <div class="mdl-card__title">
                        <h2 class="mdl-card__title-text" id="request-status-pane-title">.</h2>
                    </div>
                    <div class="mdl-card__supporting-text">
                        <div class="step-subsection" id="request-status-pane-description">
                        </div>
                        <div class="step-subsection">
                            Request details:
                            <ul class="request-details">
                                <li>
                                    <label for="request-status-pane-beneficiary">User</label>
                                    <span id="request-status-pane-beneficiary" />
                                </li>
                                <li>
                                    <label for="request-status-pane-requesttime">Request time</label>
                                    <span id="request-status-pane-requesttime" />
                                </li>
                                <li>
                                    <label for="request-status-pane-justification">Justification</label>
                                    <span id="request-status-pane-justification" />
                                </li>
                            </ul>
                        </div>
                        <div class="step-subsection">
                            <table class="mdl-data-table mdl-shadow--2dp" id="activatedroles">
                                <thead>
                                    <tr>
                                        <th class="mdl-data-table__cell--non-numeric">Role</th>
                                        <th class="mdl-data-table__cell--non-numeric">Status</th>
                                        <th class="mdl-data-table__cell--non-numeric">Expiry</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="mdl-card__actions mdl-card--border">
                        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--colored" href="https://console.cloud.google.com/" target="_blank" id="request-status-pane-console">
                            Open Console
                        </a>
                        <a class="mdl-button mdl-js-button mdl-js-ripple-effect" href="/">
                            Back
                        </a>
                    </div>
                </div>
            </div>
        </main>
        <main class="mdl-layout__content app-pane" id="help-pane">
            <div class="mdl-grid center-items">
                <div class="mdl-card mdl-shadow--2dp">
                    <div class="mdl-card__title">
                        <h2 class="mdl-card__title-text">Requesting just-in-time access</h2>
                    </div>
                    <div class="mdl-card__supporting-text">
                        <p>
                            This application lets you request temporary access to a Google Cloud project. To request access,
                            you need to provide the following:

                            <ul>
                                <li>The project to access</li>
                                <li>One or more roles to activate</li>
                                <li>A justification that explains why you need access to this project</li>
                            </ul>
                        </p>
                        <p>
                            You can only request access to projects and roles that you've been granted <i>eligible access</i> to,
                            and your access automatically expires after a certain period of time.
                        </p>
                    </div>
                </div>
            </div>
            <div class="mdl-grid center-items">
                <div class="mdl-card mdl-shadow--2dp">
                    <div class="mdl-card__title">
                        <h2 class="mdl-card__title-text">Grant just-in-time access</h2>
                    </div>
                    <div class="mdl-card__supporting-text">
                        <p>
                            As an administrator you can grant users or groups <i>eligible access</i> to Google Cloud projects.
                        </p>
                        <p>
                            To grant eligible access, use the Cloud Console or <code>gcloud</code> to create an IAM role binding for
                            a user or group, and make it eligible by adding a special IAM condition:

                            <pre><code class="language-cel">has({}.jitAccessConstraint)</code></pre>

                            You can create the IAM role binding for a specific project, or for an entire folder.
                        </p>
                        <p>
                            For example, the following <code>gcloud</code> grants eligible access to a user:
                            <pre><code class="language-cel">gcloud projects add-iam-policy-binding <b>PROJECT_ID</b> \
    --member user:<b>USER</b> \
    --role <b>ROLE</b> \
    --condition "title=Eligible access,expression=has({}.jitAccessConstraint)"
</code></pre>
                        </p>
                        <!-- TODO: Describe MPA -->
                    </div>
                </div>
            </div>
            <div class="mdl-grid center-items">
                <div class="mdl-card mdl-shadow--2dp">
                    <div class="mdl-card__title">
                        <h2 class="mdl-card__title-text">Audit and review just-in-time access</h2>
                    </div>
                    <div class="mdl-card__supporting-text">
                        <p>
                            As an administrator, you can use Cloud Logging to review when and why eligible roles have been activated by users.
                        </p>
                        <p>
                            For example, the following filter lets you find all instances when a role has been activated:
                            <pre><code class="language-cel">labels.event="api.activateRole"</code></pre>
                        </p>
                    </div>
                    <div class="mdl-card__actions mdl-card--border">
                        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--colored" href="https://console.cloud.google.com/logs/query;query=labels.event%3D%22api.activateRole%22" target="_blank">
                            Open Logs
                        </a>
                    </div>
                </div>
            </div>
        </main>
        <footer class="mdl-mini-footer">
            Powered by <a href="https://github.com/GoogleCloudPlatform/jit-access">JIT Access</a>.
        </footer>
        <div id="toast" class="mdl-snackbar mdl-js-snackbar">
            <div class="mdl-snackbar__text">Toast!</div>
            <button type="button" class="mdl-snackbar__action"></button>
        </div>
    </div>

    <!-- script -->
    <script src="model.js"></script>
    <script>
        "use strict"

        /** Helper class for modifying MDL data tables */
        class MdlDataTable {
            constructor(selector) {
                console.assert(selector);
                console.assert($(selector).length > 0);

                this.selector = selector;
                this.rowIndex = 0;
            }

            /** 
             *  Add data row.
             *  Format of column: { class: ..., text: ... }
             */
            addRow(value, columns, showCheckbox=true, enabled=true) {
                console.assert(value);
                console.assert(columns);

                const tr = $("<tr>");
                $(`${this.selector} tbody`).append(tr);

                const id = $(this.selector).attr('id') + this.rowIndex;
                if (showCheckbox) {
                    const input = $("<input type='checkbox' class='mdl-checkbox__input'></label>");
                    input.val(value);

                    const label = $(`<label class='mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect mdl-data-table__select' id='${id}'></label>`);
                    label.append(input);

                    const td = $("<td></td>");
                    td.append(label);
                    tr.append(td);
                }

                columns.forEach((value) => {
                    const div = $("<div></div>");
                    div.text(value.text);
                    if (value.class) {
                        div.attr("class", value.class);
                    }

                    const td = $("<td class='mdl-data-table__cell--non-numeric'>");
                    td.append(div);
                    tr.append(td);
                });

                componentHandler.upgradeAllRegistered();

                if (showCheckbox && !enabled) {
                    document.querySelector("#" + id).MaterialCheckbox.disable();
                }

                this.rowIndex += 1;
            }

            /** Get values of selected rows */
            get selected() {
                var boxes = $(`${this.selector} input:checked`);
                return $.map(boxes, input => input.value);
            }
        }

        /** Helper class for modifying MDL steps */
        class MdlStep {
            constructor(selector) {
                console.assert(selector);
                console.assert($(selector).length > 0);

                this.selector = selector;
            }

            /** Add handler that is triggered when a user clicks the "Continue" button of a step */
            addHandler(nextHandler) {
                console.assert(nextHandler);

                const stepperElement = document.querySelector("ul.mdl-stepper");
                console.assert(stepperElement);

                const stepper = stepperElement.MaterialStepper;
                const stepElement = stepperElement.querySelector(this.selector);

                const wrappedHandler = async (event) => {
                    try {
                        await nextHandler();
                        stepper.next();
                    }
                    catch (error) {
                        stepper.error(error);
                    }
                };

                stepElement.addEventListener("onstepnext", wrappedHandler);
                stepElement.addEventListener("onstepcancel", (event) => location.reload());

                // Trigger handler when a form is submitted.
                $(this.selector + " form").submit(function (event) {
                    event.preventDefault();
                    wrappedHandler(event);
                });
            }
        }

        /** An SPA-style pane, only one of which is shown at a time */
        class AppPane {
            constructor(id) {
                console.assert($("#" + id).length);

                this.id = id;
            }

            /**
             * Show a pane and hide all other panes.
             */
            show() {
                $(".app-pane").hide();
                $("#" + this.id).show();
            }
        }

        class RequestPane extends AppPane {
            constructor() {
                super("request-pane");

                this._requestStep = new MdlStep("#step-selectproject");
                this._selectRoleStep = new MdlStep("#step-selectrole");
                this._approveStep = new MdlStep("#step-approve");
                this._roleTable = new MdlDataTable("#step-selectrole-roles");
                this._peersTable = new MdlDataTable("#step-approve-peers");
            }

            get requestStep() {
                return this._requestStep;
            }

            get selectRoleStep() {
                return this._selectRoleStep;
            }

            get approveStep() {
                return this._approveStep;
            }

            get roleTable() {
                return this._roleTable;
            }

            get peersTable() {
                return this._peersTable;
            }

            get selectedProjectId() {
                return $("#project-selector-search").val();
            }

            set selectedProjectId(projectId) {
                $("#project-selector-search").val(projectId);
            }

            get justificationText() {
                return $("#justification").val();
            }

            set justificationHint(hint) {
                $("#step-approve legend").text(hint);
            }
        }

        class RequestStatusPane extends AppPane {
            constructor() {
                super("request-status-pane")

                this.statusCaptions = {
                    "ACTIVATED": "Active",
                    "ACTIVATION_PENDING": "Waiting for approval",
                    "ELIGIBLE_FOR_JIT": "Activation required",
                    "ELIGIBLE_FOR_MPA": "Peer approval required",
                };
            }

            get activatedRoleTable() {
                return new MdlDataTable("#activatedroles");
            }

            set activationStatus(activationStatus) {
                if (activationStatus.isApprover) {
                    // TODO: Approval UI
                }
                else {
                    if (activationStatus.items.some(i => i.status === "ACTIVATION_PENDING")) {
                        $("#request-status-pane-title").text("Status of your request");
                        $("#request-status-pane-description").text("Your request has been submitted for approval. " +
                            "You'll receive an email once approval has been granted");
                    }
                    else {
                        $("#request-status-pane-title").text("Access granted");
                        $("#request-status-pane-description").text("Your request has been submitted and access is granted.");
                    }
                }

                $("#request-status-pane-beneficiary").text(activationStatus.beneficiary);
                $("#request-status-pane-requesttime").text(new Date(activationStatus.requestTime * 1000));
                $("#request-status-pane-justification").text(activationStatus.justification);

                const nowUnixTimeSecs = (Date.now() / 1000);
                activationStatus.items.forEach((item) => {
                    this.activatedRoleTable.addRow(
                        item.roleBinding.role,
                        [
                            { text: item.roleBinding.role },
                            { text: this.statusCaptions[item.status] ?? item.status, class: item.status === "ACTIVATED" ? "activated" : null },
                            { text: `${Math.floor((item.expiry - nowUnixTimeSecs) / 60)} minutes` }
                        ],
                        false);
                });
            }
        }

        /** Wrapper for HTML-based view */
        class View {
            /** Display a toast bar at the bottom of the screen */
            showToast(message, showReloadButton) {
                console.assert(message);

                const toast = document.querySelector("#toast");
                console.assert(toast);

                const config = {
                    message: message,
                    timeout: showReloadButton ? 60000 : 10000
                }

                // Show a button to perform a cache-busting reload.
                if (showReloadButton) {
                    config.actionText = "Reload";
                    config.actionHandler = () => {
                        const timestamp = Date.now();
                        window.location.href = `${window.location.pathname}?_=${timestamp}`;
                    }
                }

                toast.MaterialSnackbar.showSnackbar(config);
            }

            get requestPane() {
                return new RequestPane();
            }

            get helpPane() {
                return new AppPane("help-pane");
            }

            get busyPane() {
                return new AppPane("busy-pane");
            }

            get requestStatusPane() {
                return new RequestStatusPane();
            }
        };

        const gui = new View();
        const backend = window.location.search === "?debug" ? new DebugModel() : new Model();
        const localSettings = new LocalSettings();

        $("#menu-requestaccess").click(() => gui.requestPane.show());
        $("#menu-help").click(() => gui.helpPane.show());
        $(document).ready(async () => {
            //
            // Configure steps.
            //
            (function () {
                componentHandler.upgradeAllRegistered();

                const statusCaptions = {// TODO: Move to AppPane
                    "ACTIVATED": "Active",
                    "ACTIVATION_PENDING": "Waiting for approval",
                    "ELIGIBLE_FOR_JIT": "Activation required",
                    "ELIGIBLE_FOR_MPA": "Peer approval required",
                };

                //
                // Step: Select project.
                //
                let roles;
                const requestPane = gui.requestPane;
                requestPane.selectedProjectId = localSettings.lastProjectId;
                requestPane.requestStep.addHandler(async () => {
                    if (!(requestPane.selectedProjectId)) {
                        throw "Select a project";
                    }

                    localSettings.lastProjectId = requestPane.selectedProjectId;

                    //
                    // Request and list roles available in that project.
                    //
                    const rolesResult = await backend.listRoles(requestPane.selectedProjectId)
                    if (!rolesResult.roles || rolesResult.roles.length == 0) {
                        throw "The project doesn't exist, or you don't have permission to activate any roles in this project";
                    }

                    if (rolesResult.warnings && rolesResult.warnings.length > 0) {
                        gui.showToast(rolesResult.warnings.join(", "));
                    }

                    roles = rolesResult.roles;
                    roles.forEach((item) => {
                        requestPane.roleTable.addRow(
                            item.roleBinding.role,
                            [
                                { text: item.roleBinding.role },
                                { text: statusCaptions[item.status] ?? item.status, class: item.status === "ACTIVATED" ? "activated" : null }
                            ],
                            true,
                            item.status !== "ACTIVATED");
                    });
                });

                //
                // Step: Select role.
                //
                let multiPartyApproval;
                requestPane.selectRoleStep.addHandler(async () => {
                    console.assert(roles);
                    const selectedRoles = roles.filter(i => requestPane.roleTable.selected.includes(i.roleBinding.role));

                    if (selectedRoles.length === 0) {
                        throw "Select one or more roles to actviate";
                    }

                    if (selectedRoles.some(i => i.status === "ELIGIBLE_FOR_MPA")) {
                        //
                        // Multi-party approval: Request and list peers available for this project and role.
                        //
                        multiPartyApproval = true;

                        if (selectedRoles.length > 1) {
                            throw "You can only request peer approval for a single role at a time";
                        }

                        const peersResult = await backend.listPeers(requestPane.selectedProjectId, selectedRoles[0].roleBinding.role);

                        if (!peersResult.peers || peersResult.peers.length == 0) {
                            throw "There are currently no peers that could approve your request";
                        }

                        peersResult.peers.forEach((item) => {
                            requestPane.peersTable.addRow(
                                item.email,
                                [
                                    { text: item.email }
                                ],
                                true);
                        });
                    }
                    else {
                        //
                        // Self - approval.
                        //
                        multiPartyApproval = false;
                        $(".conditional-mpa").hide();
                    }

                    requestPane.justificationHint = backend.policy.justificationHint;
                });

                //
                // Step: Approve.
                //
                requestPane.approveStep.addHandler(async () => {
                    if (multiPartyApproval && gui.requestPane.peersTable.selected.length === 0) {
                        throw "Select one or more peers";
                    }
                    if (!requestPane.justificationText) {
                        throw "Enter a justification";
                    }

                    gui.busyPane.show();
                    try {
                        let activationStatus;
                        if (multiPartyApproval) {
                            console.assert(requestPane.roleTable.selected.length == 1);
                            activationStatus = await backend.activateRole(
                                requestPane.selectedProjectId,
                                requestPane.roleTable.selected[0],
                                requestPane.peersTable.selected,
                                requestPane.justificationText);
                        }
                        else {
                            activationStatus = await backend.selfActivateRoles(
                                requestPane.selectedProjectId,
                                requestPane.roleTable.selected,
                                requestPane.justificationText)
                        }

                        gui.requestStatusPane.activationStatus = activationStatus;
                        gui.requestStatusPane.show();
                    }
                    catch (error) {
                        gui.showToast(error);
                        gui.requestPane.show();
                    }
                });
            }());

            //
            // Add Copy button to code blocks.
            //
            (function () {
                document.querySelectorAll("pre").forEach((block) => {
                    if (navigator.clipboard) {
                        const img = document.createElement("img");
                        img.src = "icon.copy.svg";

                        const button = document.createElement("button");
                        button.appendChild(img);
                        block.appendChild(button);

                        button.addEventListener("click", async () => {
                            const code = block.querySelector("code");
                            const text = code.innerText;

                            await navigator.clipboard.writeText(text);
                        });
                    }
                });
            }());

            //
            // Configure project selector
            //
            $("#project-selector-search").autocomplete({
                source: async (request, response) => {
                    try {
                        const projects = await backend.searchProjects(request.term);
                        response($.map(projects, (item) => {
                            return {
                                label: item,
                                value: item
                            };
                        }));
                    }
                    catch (e) {
                        gui.showToast(`Loading projects failed: ${e}`, false);
                    }
                },
                minLength: 2,
                position: { of: $("#project-selector") }
            });

            //
            // Downlaod policy to check if the communication with the backend
            // works properly. 
            //
            try {
                await backend.fetchPolicy();
                gui.requestPane.show();
            }
            catch (error) {
                gui.showToast(error, true);
            }
        });
    </script>
</body>
</html>
